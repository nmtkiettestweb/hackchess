<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AI Chess Master - Elite Stockfish</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <style>
        :root { --primary: #00ff88; --bg: #121212; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .container { display: flex; gap: 20px; background: #222; padding: 25px; border-radius: 15px; border: 1px solid #333; }
        #board { width: 500px; height: 500px; background: #333; }
        .sidebar { width: 320px; display: flex; flex-direction: column; }
        .chat-box { flex: 1; background: #000; border-radius: 8px; padding: 15px; overflow-y: auto; height: 350px; margin-bottom: 10px; border: 1px solid #444; }
        .msg { margin-bottom: 10px; font-size: 13px; line-height: 1.4; padding: 8px; border-radius: 4px; }
        .ai { background: #1b4d3e; color: var(--primary); }
        .user { background: #2c3e50; color: #3498db; text-align: right; }
        .input-group { display: flex; gap: 5px; }
        input { flex: 1; background: #333; border: 1px solid #555; color: white; padding: 10px; border-radius: 4px; outline: none; }
        button { padding: 10px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-new { background: var(--primary); color: #000; margin-top: 10px; }
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #333; padding: 30px; border-radius: 15px; text-align: center; border: 1px solid var(--primary); }
    </style>
</head>
<body>

<div id="modal">
    <div class="modal-content">
        <h2>CHỌN PHE ĐỂ BẮT ĐẦU</h2>
        <button onclick="startGame('w')" style="padding:15px 30px; background:#fff; color:#000; font-weight:bold; margin:10px;">TRẮNG (AI ĐI TRƯỚC)</button>
        <button onclick="startGame('b')" style="padding:15px 30px; background:#000; color:#fff; border:1px solid #fff; margin:10px;">ĐEN (ĐỊCH ĐI TRƯỚC)</button>
    </div>
</div>

<div class="container">
    <div>
        <div id="status" style="text-align: center; color: #f1c40f; font-weight: bold; margin-bottom: 5px;">Hệ Thống Sẵn Sàng</div>
        <div id="board"></div>
    </div>
    <div class="sidebar">
        <div class="chat-box" id="chat">
            <div class="msg ai"><b>AI:</b> Đã tải xong Engine. Hãy chọn phe!</div>
        </div>
        <div class="input-group">
            <input type="text" id="move-input" placeholder="Nhập nước địch (vd: e5)...">
            <button style="background: #f39c12;" onclick="handleEnemy()">GỬI</button>
        </div>
        <button class="btn-new" onclick="location.reload()">LÀM MỚI TRẬN ĐẤU</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
    let board = null;
    let game = new Chess();
    let sf = null;

    // Khởi tạo Engine Stockfish
    function initEngine() {
        if (sf) sf.terminate(); // Tắt engine cũ nếu có
        sf = new Worker('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');
        
        sf.onmessage = function(e) {
            if (e.data.startsWith('bestmove')) {
                let move = e.data.split(' ')[1];
                let m = game.move(move, { sloppy: true });
                board.position(game.fen());
                addChat('ai', `Tôi gợi ý & tự đi: <b>${m.san}</b>`);
                updateStatus();
            }
        };
    }

    function addChat(role, text) {
        let cls = role === 'ai' ? 'ai' : 'user';
        $('#chat').append(`<div class="msg ${cls}"><b>${role.toUpperCase()}:</b> ${text}</div>`);
        $('#chat').scrollTop($('#chat')[0].scrollHeight);
    }

    function askAI() {
        if (game.game_over()) return;
        sf.postMessage('position fen ' + game.fen());
        sf.postMessage('go depth 15');
    }

    function startGame(side) {
        $('#modal').hide();
        initEngine(); // Chạy engine ngay khi chọn phe
        game.reset();
        
        board = ChessBoard('board', {
            position: 'start',
            orientation: side === 'w' ? 'white' : 'black',
            draggable: false,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
        
        // Buộc bàn cờ vẽ lại đúng kích thước
        setTimeout(() => { board.resize(); }, 100);

        if (side === 'w') {
            addChat('ai', "Bạn cầm Trắng. Tôi đang tính nước khai cuộc...");
            setTimeout(askAI, 500);
        } else {
            addChat('ai', "Bạn cầm Đen. Chờ đối thủ đi nước đầu tiên.");
        }
        updateStatus();
    }

    function handleEnemy() {
        let val = $('#move-input').val().trim();
        let m = game.move(val);
        if (m) {
            board.position(game.fen());
            addChat('user', `Địch đi: ${val}`);
            $('#move-input').val('');
            updateStatus();
            if (!game.game_over()) setTimeout(askAI, 500);
        } else {
            alert("Nước đi sai luật!");
        }
    }

    function updateStatus() {
        let status = game.in_checkmate() ? "CHIẾU BÍ!" : (game.in_draw() ? "HÒA" : "ĐANG CHƠI");
        $('#status').text(status);
    }

    $('#move-input').keypress(e => { if(e.which == 13) handleEnemy(); });
</script>
</body>
</html>
