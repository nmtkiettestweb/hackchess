<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AI Chess Elite - Stockfish 16</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <style>
        :root { --primary: #00ff88; --bg: #121212; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .container { display: flex; gap: 20px; background: #222; padding: 25px; border-radius: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.7); border: 1px solid #333; }
        #board { width: 550px; height: 550px; }
        .sidebar { width: 350px; display: flex; flex-direction: column; }
        .chat-box { flex: 1; background: #000; border: 1px solid #444; border-radius: 8px; padding: 15px; overflow-y: auto; height: 400px; margin-bottom: 15px; }
        .msg { margin-bottom: 12px; font-size: 14px; padding: 8px; border-radius: 5px; line-height: 1.5; }
        .ai { background: #1b4d3e; color: var(--primary); border-left: 4px solid var(--primary); }
        .user { background: #2c3e50; color: #3498db; text-align: right; border-right: 4px solid #3498db; }
        .input-group { display: flex; gap: 5px; }
        input { flex: 1; background: #333; border: 1px solid #555; color: white; padding: 12px; border-radius: 5px; outline: none; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .btn-new { background: var(--primary); color: #000; width: 100%; margin-top: 10px; }
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #333; padding: 40px; border-radius: 20px; text-align: center; border: 2px solid var(--primary); }
        .side-btn { padding: 20px; font-size: 1.1rem; margin: 10px; width: 150px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="modal">
    <div class="modal-content">
        <h2 style="margin-top:0">CHỌN PHE CỦA BẠN</h2>
        <p>Ghi chú: Trắng luôn đi trước</p>
        <button class="side-btn" style="background:#fff; color:#000" onclick="initGame('w')">TÔI PHE TRẮNG</button>
        <button class="side-btn" style="background:#000; color:#fff; border:1px solid #fff" onclick="initGame('b')">TÔI PHE ĐEN</button>
    </div>
</div>

<div class="container">
    <div>
        <div id="status" style="text-align: center; color: #f1c40f; font-weight: bold; padding-bottom: 10px;">STOCKFISH 16.1 READY</div>
        <div id="board"></div>
    </div>
    <div class="sidebar">
        <div class="chat-box" id="chat">
            <div class="msg ai"><b>AI:</b> Chào bạn. Hãy chọn phe để bắt đầu trận đấu.</div>
        </div>
        <div class="input-group">
            <input type="text" id="move-input" placeholder="Nhập nước đi của đối thủ...">
            <button style="background: #f39c12; color: #000;" onclick="handleEnemy()">GỬI</button>
        </div>
        <button class="btn-new" onclick="location.reload()">BÀN CỜ MỚI</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
    let board = null;
    let game = new Chess();
    let sf = new Worker('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');
    let userColor = 'w';

    function addChat(role, text) {
        let cls = role === 'ai' ? 'ai' : 'user';
        $('#chat').append(`<div class="msg ${cls}"><b>${role.toUpperCase()}:</b> ${text}</div>`);
        $('#chat').scrollTop($('#chat')[0].scrollHeight);
    }

    sf.onmessage = function(e) {
        if (e.data.startsWith('bestmove')) {
            let move = e.data.split(' ')[1];
            let m = game.move(move, { sloppy: true });
            board.position(game.fen());
            addChat('ai', `Nước đi gợi ý tốt nhất: <b>${m.san}</b> (Tôi đã tự di chuyển cho bạn)`);
            updateStatus();
        }
    };

    function askAI() {
        if (game.game_over()) return;
        addChat('ai', "Đang tính toán...");
        sf.postMessage('position fen ' + game.fen());
        sf.postMessage('go depth 18');
    }

    function initGame(side) {
        userColor = side;
        $('#modal').hide();
        game.reset();
        
        board = ChessBoard('board', {
            position: 'start',
            orientation: side === 'w' ? 'white' : 'black',
            draggable: false,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });

        if (side === 'w') {
            addChat('ai', "Bạn cầm Trắng - Bạn đi trước. Đang gợi ý nước khai cuộc...");
            setTimeout(askAI, 500);
        } else {
            addChat('ai', "Bạn cầm Đen - Đối thủ (Trắng) đi trước. Vui lòng nhập nước đi của họ.");
        }
        updateStatus();
    }

    function handleEnemy() {
        let val = $('#move-input').val().trim();
        let m = game.move(val);
        
        if (m) {
            board.position(game.fen());
            addChat('user', `Đối thủ vừa đi: ${val}`);
            $('#move-input').val('');
            updateStatus();
            if (!game.game_over()) {
                setTimeout(askAI, 600);
            }
        } else {
            alert("Nước đi không hợp lệ!");
        }
    }

    function updateStatus() {
        let status = "ĐANG CHƠI";
        if (game.in_checkmate()) status = "HẾT CỜ - CHIẾU BÍ!";
        if (game.in_draw()) status = "HÒA CỜ!";
        $('#status').text("TRẠNG THÁI: " + status);
    }

    $('#move-input').keypress(e => { if(e.which == 13) handleEnemy(); });
</script>
</body>
</html>
