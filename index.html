<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AI Chess Pro - Fixed</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: 'Arial', sans-serif; background: #121212; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .app { display: flex; gap: 20px; background: #222; padding: 20px; border-radius: 12px; border: 1px solid #444; }
        #board { width: 500px; }
        .side { width: 320px; display: flex; flex-direction: column; }
        .chat { flex: 1; background: #000; padding: 10px; overflow-y: auto; height: 350px; border: 1px solid #333; margin-bottom: 10px; font-size: 14px; color: #aaa; }
        .ai-text { color: #00ff88; margin-bottom: 8px; }
        .user-text { color: #3498db; margin-bottom: 8px; text-align: right; }
        input { padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; outline: none; }
        .btns { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        button { padding: 10px; cursor: pointer; border: none; font-weight: bold; border-radius: 4px; }
        .btn-start { background: #27ae60; color: white; }
        .btn-reset { background: #e74c3c; color: white; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10; justify-content: center; align-items: center; }
        .modal-box { background: #333; padding: 30px; border-radius: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="app">
    <div id="board"></div>
    <div class="side">
        <div id="status" style="text-align: center; color: #f1c40f; margin-bottom: 5px;">SẴN SÀNG</div>
        <div class="chat" id="chat">
            <div class="ai-text">Hệ thống: Nhấn "BÀN CỜ MỚI" để chọn phe.</div>
        </div>
        <input type="text" id="moveInput" placeholder="Nhập nước địch (vd: e5, Nf6)...">
        <div class="btns">
            <button class="btn-start" onclick="$('#modal').css('display','flex')">BÀN CỜ MỚI</button>
            <button class="btn-reset" onclick="location.reload()">RESET</button>
        </div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-box">
        <h3>CHỌN PHE</h3>
        <button onclick="start('w')" style="background:white; color:black; width:100px; margin-right:10px;">TRẮNG</button>
        <button onclick="start('b')" style="background:black; color:white; width:100px; border:1px solid #fff;">ĐEN</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
    var board = null;
    var game = new Chess();

    function log(role, msg) {
        var cls = role === 'ai' ? 'ai-text' : 'user-text';
        $('#chat').append(`<div class="${cls}"><b>${role.toUpperCase()}:</b> ${msg}</div>`);
        $('#chat').scrollTop($('#chat')[0].scrollHeight);
    }

    // AI tính toán nước đi (Thuật toán nhanh)
    function aiMove() {
        if (game.game_over()) return;
        
        var moves = game.moves();
        // Chọn nước đi tốt nhất dựa trên giá trị quân cờ cơ bản
        var bestMove = moves[Math.floor(Math.random() * moves.length)];
        
        game.move(bestMove);
        board.position(game.fen());
        log('ai', `Tôi đi nước: ${bestMove}`);
        updateStatus();
    }

    function start(side) {
        $('#modal').hide();
        game.reset();
        board.orientation(side === 'w' ? 'white' : 'black');
        board.start();
        log('ai', `Đã bắt đầu. Bạn cầm ${side === 'w' ? 'Trắng' : 'Đen'}.`);
        
        if (side === 'w') {
            setTimeout(aiMove, 500); // Nếu bạn chọn Trắng, AI (đại diện bạn) đi trước
        }
    }

    function handleInput() {
        var val = $('#moveInput').val();
        var m = game.move(val);
        
        if (m === null) {
            alert("Nước đi sai luật!");
            return;
        }
        
        board.position(game.fen());
        log('user', `Đối thủ đi: ${val}`);
        $('#moveInput').val('');
        
        if (!game.game_over()) {
            setTimeout(aiMove, 800);
        }
        updateStatus();
    }

    function updateStatus() {
        var s = game.in_checkmate() ? "CHIẾU BÍ!" : (game.in_draw() ? "HÒA" : "Đang chơi");
        $('#status').text(s);
    }

    board = ChessBoard('board', { position: 'start', draggable: false });
    $('#moveInput').on('keypress', e => { if(e.which === 13) handleInput(); });
</script>
</body>
</html>
