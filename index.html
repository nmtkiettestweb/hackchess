<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AI Chess Vô Địch - Stockfish Engine</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        :root { --primary: #00ff88; --bg: #1a1a1a; --panel: #252525; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .container { display: flex; gap: 20px; background: var(--panel); padding: 20px; border-radius: 12px; box-shadow: 0 0 40px rgba(0,0,0,0.6); }
        #board { width: 500px; }
        .sidebar { width: 350px; display: flex; flex-direction: column; gap: 15px; }
        .chat-box { flex: 1; background: #111; border: 1px solid #444; border-radius: 8px; padding: 10px; overflow-y: auto; height: 350px; font-size: 13px; }
        .msg { margin-bottom: 8px; padding: 5px 10px; border-radius: 4px; }
        .ai { color: var(--primary); border-left: 2px solid var(--primary); background: rgba(0,255,136,0.05); }
        .user { color: #3498db; border-left: 2px solid #3498db; background: rgba(52,152,219,0.05); }
        .input-group { display: flex; gap: 5px; }
        input { flex: 1; background: #333; border: 1px solid #555; color: white; padding: 10px; border-radius: 4px; outline: none; }
        button { cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        .btn-main { background: var(--primary); color: #000; padding: 10px; }
        .btn-danger { background: #e74c3c; color: white; padding: 10px; }
        #status { color: #f1c40f; text-align: center; font-weight: bold; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: #333; padding: 30px; border-radius: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div>
        <div id="status">CHỜ BẮT ĐẦU</div>
        <div id="board"></div>
    </div>
    <div class="sidebar">
        <div class="chat-box" id="chat-box">
            <div class="msg ai">Hệ thống: Stockfish 16.1 đã sẵn sàng. Độ trễ < 10ms.</div>
        </div>
        <div class="input-group">
            <input type="text" id="enemy-move" placeholder="Nhập nước đi (vd: e5)...">
            <button class="btn-main" onclick="handleEnemyMove()">GỬI</button>
        </div>
        <button class="btn-main" style="background: #2ecc71;" onclick="$('#sideModal').show()">BÀN CỜ MỚI</button>
        <button class="btn-danger" onclick="location.reload()">RESET</button>
    </div>
</div>

<div id="sideModal" class="modal">
    <div class="modal-content">
        <h3>CHỌN PHE CỦA BẠN</h3>
        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button style="flex:1; padding: 20px; background: white; color: black;" onclick="initGame('w')">TRẮNG</button>
            <button style="flex:1; padding: 20px; background: black; color: white; border: 1px solid white;" onclick="initGame('b')">ĐEN</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
    let board = null;
    let game = new Chess();
    let stockfish = new Worker('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');
    let aiColor = 'w';

    // Cấu hình Stockfish
    stockfish.onmessage = function(event) {
        if (event.data.startsWith('bestmove')) {
            let move = event.data.split(' ')[1];
            makeMove(move);
        }
    };

    function addChat(role, text) {
        $('#chat-box').append(`<div class="msg ${role}"><b>${role.toUpperCase()}:</b> ${text}</div>`);
        $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
    }

    function initGame(side) {
        game.reset();
        aiColor = side; // AI sẽ đại diện cho bạn
        board.orientation(side === 'w' ? 'white' : 'black');
        board.start();
        $('#sideModal').hide();
        addChat('ai', `Ván mới. Bạn cầm ${side === 'w' ? 'Trắng' : 'Đen'}. Tôi sẽ tự đánh.`);
        
        if (side === 'w') {
            askStockfish();
        } else {
            addChat('ai', "Đang chờ nước đi đầu tiên từ đối thủ...");
        }
    }

    function askStockfish() {
        stockfish.postMessage('position fen ' + game.fen());
        stockfish.postMessage('go depth 15'); // Độ sâu 15 giúp suy luận nhanh tức thì
    }

    function makeMove(move) {
        let result = game.move(move, { sloppy: true });
        board.position(game.fen());
        addChat('ai', `Tôi đi: ${result.san}`);
        updateStatus();
    }

    function handleEnemyMove() {
        let input = $('#enemy-move').val().trim();
        let move = game.move(input);
        
        if (move === null) {
            addChat('ai', "Lỗi: Nước đi không hợp lệ!");
            return;
        }

        board.position(game.fen());
        addChat('user', `Đối thủ đi: ${input}`);
        $('#enemy-move').val('');
        updateStatus();

        if (!game.game_over()) {
            setTimeout(askStockfish, 200);
        }
    }

    function updateStatus() {
        let status = game.in_checkmate() ? "CHIẾU BÍ!" : (game.in_draw() ? "HÒA" : "Đang đánh...");
        $('#status').text(status);
    }

    board = ChessBoard('board', { position: 'start', draggable: false });
    $('#enemy-move').on('keypress', e => { if(e.which === 13) handleEnemyMove(); });
</script>
</body>
</html>
