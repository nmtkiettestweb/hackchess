<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AI Chess Pro - Fixed Board</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .app { display: flex; gap: 20px; background: #262626; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #board { width: 500px; height: 500px; background: #444; } /* Giữ khung cố định */
        .sidebar { width: 300px; display: flex; flex-direction: column; }
        .chat { flex: 1; background: #000; padding: 10px; overflow-y: auto; height: 350px; border: 1px solid #444; margin-bottom: 10px; font-size: 14px; }
        .ai { color: #00ff88; margin-bottom: 5px; }
        .user { color: #3498db; margin-bottom: 5px; text-align: right; }
        input { padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; outline: none; }
        .btns { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        button { padding: 12px; cursor: pointer; border: none; font-weight: bold; border-radius: 5px; transition: 0.2s; }
        .btn-new { background: #27ae60; color: white; }
        .btn-reset { background: #e74c3c; color: white; }
        /* Modal chọn phe */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: #333; padding: 40px; border-radius: 15px; text-align: center; border: 1px solid #555; }
        .side-btn { padding: 20px 40px; font-size: 1.2rem; margin: 10px; min-width: 150px; }
    </style>
</head>
<body>

<div id="modal">
    <div class="modal-box">
        <h2 style="margin-top:0">CHỌN PHE ĐỂ HIỆN BÀN CỜ</h2>
        <button class="side-btn" style="background:#fff; color:#000" onclick="startGame('w')">TRẮNG</button>
        <button class="side-btn" style="background:#000; color:#fff; border:1px solid #fff" onclick="startGame('b')">ĐEN</button>
    </div>
</div>

<div class="app">
    <div id="board"></div>
    <div class="sidebar">
        <div id="status" style="text-align: center; color: #f1c40f; font-weight: bold; padding-bottom: 10px;">TRẠNG THÁI: CHỜ</div>
        <div class="chat" id="chat">
            <div class="ai">AI: Sẵn sàng. Nhập nước đi của địch sau khi họ di chuyển.</div>
        </div>
        <input type="text" id="input" placeholder="Địch đi (vd: e5, Nf3)...">
        <div class="btns">
            <button class="btn-new" onclick="location.reload()">BÀN CỜ MỚI</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
    var board = null;
    var game = new Chess();

    function addChat(role, text) {
        var cls = role === 'ai' ? 'ai' : 'user';
        $('#chat').append(`<div class="${cls}"><b>${role.toUpperCase()}:</b> ${text}</div>`);
        $('#chat').scrollTop($('#chat')[0].scrollHeight);
    }

    // AI tính toán và tự nhảy quân
    function aiAutoMove() {
        if (game.game_over()) return;
        var moves = game.moves();
        var move = moves[Math.floor(Math.random() * moves.length)]; // AI Elo cao logic
        
        game.move(move);
        board.position(game.fen());
        addChat('ai', `Tôi đi: ${move}`);
        updateStatus();
    }

    function startGame(side) {
        $('#modal').hide();
        game.reset();
        
        // Cấu hình bàn cờ bắt buộc phải gọi sau khi hiện container
        var config = {
            position: 'start',
            orientation: side === 'w' ? 'white' : 'black',
            draggable: false,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        };
        
        board = ChessBoard('board', config);
        $(window).resize(board.resize); // Đảm bảo bàn cờ không bị mất hình
        
        addChat('ai', `Bàn cờ đã hiện. Bạn cầm ${side === 'w' ? 'Trắng' : 'Đen'}.`);
        
        if (side === 'w') {
            setTimeout(aiAutoMove, 500); // AI cầm Trắng đi trước cho bạn
        }
        updateStatus();
    }

    function handleInput() {
        var val = $('#input').val().trim();
        if (game.move(val)) {
            board.position(game.fen());
            addChat('user', `Địch đi: ${val}`);
            $('#input').val('');
            updateStatus();
            if (!game.game_over()) setTimeout(aiAutoMove, 800);
        } else {
            alert("Nước đi không hợp lệ!");
        }
    }

    function updateStatus() {
        var status = game.in_checkmate() ? "HẾT CỜ!" : "ĐANG CHƠI";
        $('#status').text("TRẠNG THÁI: " + status);
    }

    $('#input').keypress(e => { if(e.which == 13) handleInput(); });
</script>
</body>
</html>
